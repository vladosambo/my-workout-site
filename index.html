<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-–ù–µ–¥–µ–ª—å–Ω–∞—è –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
            color: #1e293b; /* Slate 800 */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Tempo Animation */
        .tempo-visualizer {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .tempo-bar {
            height: 100%;
            background-color: #10b981; /* Emerald 500 */
            width: 0%;
        }

        @keyframes tempo-2-0-1 {
            0% { width: 0%; left: 0; background-color: #ef4444; } /* Start eccentric */
            66% { width: 100%; left: 0; background-color: #ef4444; } /* 2s Eccentric done */
            67% { width: 100%; left: 0; background-color: #3b82f6; } /* Pause (0s - skip) */
            100% { width: 0%; left: 0; background-color: #10b981; } /* 1s Concentric */
        }

        .animate-tempo {
            animation: tempo-2-0-1 3s infinite linear;
        }

        .tab-active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .tab-inactive {
            background-color: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        .tab-inactive:hover {
            border-color: #cbd5e1;
            color: #334155;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Chosen Palette: Slate (Neutral Backgrounds) & Emerald (Action/Success) for a calm, professional gym aesthetic. -->
    <!-- Application Structure Plan:
        1. Hero Section: Quick overview of the 8-week goal.
        2. "The System" (Principles): Interactive cards explaining Tempo, RIR, and Deloads.
        3. Dashboard (Interactive Schedule): The core feature. A Week/Day selector that dynamically renders the specific workout for that day, handling the logic of Sets, Reps, and Weight adjustments (Deload vs Progression).
        4. Progression Visualizer: A Chart.js Line chart allowing users to simulate their strength gains over 8 weeks based on the program's algorithms.
        5. Log Generator: A utility to copy the daily plan to clipboard.
        6. Gemini Integration: Added Technique Checklist per exercise and Nutrition Strategy per week for enhanced planning.
        Rationale: This structure moves from understanding the "Why" to executing the "What", visualizing the "Result", and providing dynamic, context-aware advice via LLM.
    -->
    <!-- Visualization & Content Choices:
        1. Bar Chart (Volume/Intensity): Shows the wave-like structure of the program (Load vs Deload). Goal: Inform about periodization.
        2. Line Chart (Strength Projection): Interactive simulation. Goal: Motivate by showing potential result.
        3. Dynamic Tables/Cards: For the daily workouts. Preferred over static HTML tables for mobile responsiveness and interactivity (toggling weeks).
        4. CSS Animation: To visually explain the 2-0-1 tempo.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Modal for LLM results and alerts -->
    <div id="app-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h4 id="modal-title" class="text-xl font-bold text-slate-900">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h4>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-800 font-bold text-xl">&times;</button>
            </div>
            <div id="modal-body" class="text-slate-700 text-sm overflow-y-auto max-h-[70vh]">
                <!-- Content or Spinner -->
                <div id="modal-loading" class="hidden flex justify-center items-center py-8">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div id="modal-sources" class="text-xs text-slate-500 mt-4 border-t pt-2 hidden">
                <p class="font-semibold mb-1">–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</p>
                <ul id="sources-list" class="list-disc list-inside space-y-1"></ul>
            </div>
            <button id="modal-close-btn" onclick="closeModal()" class="w-full mt-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">8-Week <span class="text-emerald-600">Full-Body</span> Builder</h1>
            <nav class="hidden md:flex space-x-6 text-sm font-medium text-slate-600">
                <a href="#principles" class="hover:text-emerald-600 transition">–ü—Ä–∏–Ω—Ü–∏–ø—ã</a>
                <a href="#schedule" class="hover:text-emerald-600 transition">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
                <a href="#forecast" class="hover:text-emerald-600 transition">–ü—Ä–æ–≥–Ω–æ–∑</a>
            </nav>
        </div>
    </header>

    <main class="flex-grow">
        
        <!-- Hero Section -->
        <section class="bg-slate-50 py-12 border-b border-slate-200">
            <div class="max-w-4xl mx-auto px-4 text-center">
                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-4">–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ —Å–∏–ª—ã –∏ –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏</h2>
                <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto">
                    –ü–æ–ª–Ω–∞—è 8-–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞: 3 –¥–Ω—è –≤ –Ω–µ–¥–µ–ª—é, –≤–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ä–∞–∑–≥—Ä—É–∑–æ—á–Ω—ã–µ –Ω–µ–¥–µ–ª–∏ (Deload) –∏ —á—ë—Ç–∫–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
                </p>
                <div class="flex flex-wrap justify-center gap-4">
                    <span class="px-4 py-2 bg-white border border-slate-200 rounded-full shadow-sm text-sm font-semibold text-slate-700">üóìÔ∏è 8 –ù–µ–¥–µ–ª—å</span>
                    <span class="px-4 py-2 bg-white border border-slate-200 rounded-full shadow-sm text-sm font-semibold text-slate-700">üí™ Full Body</span>
                    <span class="px-4 py-2 bg-white border border-slate-200 rounded-full shadow-sm text-sm font-semibold text-slate-700">üìâ RPE/RIR –ö–æ–Ω—Ç—Ä–æ–ª—å</span>
                </div>
            </div>
        </section>

        <!-- Principles & Logic Section -->
        <section id="principles" class="py-12 max-w-6xl mx-auto px-4">
            <div class="mb-8">
                <h3 class="text-2xl font-bold text-slate-900 mb-2">–ü—Ä–∞–≤–∏–ª–∞ –ò–≥—Ä—ã</h3>
                <p class="text-slate-600">–ß—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–ª–∞, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å —Ç–µ–º–ø, –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∏ –º–µ—Ö–∞–Ω–∏–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Tempo Card -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="text-emerald-600 text-2xl mb-2">‚è±Ô∏è</div>
                    <h4 class="font-bold text-lg mb-2">–¢–µ–º–ø 2-0-1</h4>
                    <p class="text-sm text-slate-600 mb-4">2 —Å–µ–∫ –æ–ø—É—Å–∫–∞–µ–º (—ç–∫—Å—Ü–µ–Ω—Ç—Ä–∏–∫–∞), 0 —Å–µ–∫ –ø–∞—É–∑–∞, 1 —Å–µ–∫ –º–æ—â–Ω—ã–π –ø–æ–¥—ä–µ–º.</p>
                    <div class="bg-slate-100 rounded p-2">
                        <div class="text-xs text-center text-slate-400 mb-1">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–∞</div>
                        <div class="tempo-visualizer">
                            <div class="tempo-bar animate-tempo"></div>
                        </div>
                    </div>
                </div>

                <!-- Progression Card -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="text-emerald-600 text-2xl mb-2">üìà</div>
                    <h4 class="font-bold text-lg mb-2">–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è</h4>
                    <p class="text-sm text-slate-600">
                        –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏–ª –ø–ª–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4x8) —Å –∑–∞–ø–∞—Å–æ–º ‚Äî –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ <strong>+2.5–∫–≥</strong> (–≤–µ—Ä—Ö) –∏–ª–∏ <strong>+5-10–∫–≥</strong> (–Ω–æ–≥–∏).
                    </p>
                </div>

                <!-- RIR Card -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="text-emerald-600 text-2xl mb-2">üîã</div>
                    <h4 class="font-bold text-lg mb-2">RIR 1-2</h4>
                    <p class="text-sm text-slate-600">
                        –û—Å—Ç–∞–≤–ª—è–π 1-2 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –∑–∞–ø–∞—Å–µ. –ù–µ —Ä–∞–±–æ—Ç–∞–π –¥–æ –ø–æ–ª–Ω–æ–≥–æ –º—ã—à–µ—á–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≥—Ä—É–∑–∫–æ–π.
                    </p>
                </div>

                <!-- Deload Card -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <div class="text-emerald-600 text-2xl mb-2">üõë</div>
                    <h4 class="font-bold text-lg mb-2">–î–µ–ª–æ–∞–¥ (Deload)</h4>
                    <p class="text-sm text-slate-600">
                        –ù–µ–¥–µ–ª–∏ 4 –∏ 8. –í–µ—Å–∞ —Å–Ω–∏–∂–∞—é—Ç—Å—è –Ω–∞ 50%. –≠—Ç–æ –Ω–µ –æ—Ç–¥—ã—Ö, —ç—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¶–ù–° –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä—ã–≤–∫–∞.
                    </p>
                </div>
            </div>
        </section>

        <!-- Main Dashboard: The Workout Schedule -->
        <section id="schedule" class="bg-white py-12 border-y border-slate-200">
            <div class="max-w-6xl mx-auto px-4">
                <div class="mb-8 md:flex md:justify-between md:items-end">
                    <div>
                        <h3 class="text-2xl font-bold text-slate-900 mb-2">–î–Ω–µ–≤–Ω–∏–∫ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                        <p class="text-slate-600 max-w-2xl">
                            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é –∏ –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–π –ø–ª–∞–Ω. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–µ—Å—É.
                        </p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <button onclick="copyWorkoutToClipboard()" class="inline-flex items-center px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition text-sm font-medium">
                            üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –¥–Ω—è
                        </button>
                    </div>
                </div>

                <!-- Week Selector -->
                <div class="mb-6 overflow-x-auto pb-2">
                    <div class="flex space-x-2" id="week-selector">
                        <!-- JS generated weeks -->
                    </div>
                </div>

                <!-- Day Selector -->
                <div class="flex justify-center mb-8">
                    <div class="bg-slate-100 p-1 rounded-lg inline-flex" id="day-selector">
                        <button onclick="selectDay('Mon')" id="btn-Mon" class="px-6 py-2 rounded-md text-sm font-medium transition tab-active shadow-sm">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</button>
                        <button onclick="selectDay('Wed')" id="btn-Wed" class="px-6 py-2 rounded-md text-sm font-medium transition text-slate-600 hover:text-slate-900">–°—Ä–µ–¥–∞</button>
                        <button onclick="selectDay('Fri')" id="btn-Fri" class="px-6 py-2 rounded-md text-sm font-medium transition text-slate-600 hover:text-slate-900">–ü—è—Ç–Ω–∏—Ü–∞</button>
                    </div>
                </div>

                <!-- Dynamic Content Area -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Workout List -->
                    <div class="lg:col-span-2 space-y-4" id="workout-list">
                        <!-- Exercises will be injected here -->
                    </div>

                    <!-- Context/Notes Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-6 sticky top-24">
                            <h4 class="font-bold text-emerald-900 mb-4 text-lg">–§–æ–∫—É—Å —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏</h4>
                            <div id="week-notes" class="text-sm text-emerald-800 space-y-3">
                                <!-- Dynamic notes -->
                            </div>
                            
                            <button onclick="generateNutritionStrategy()" class="w-full mt-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium text-sm flex items-center justify-center space-x-2">
                                <span>‚ú® –ü–ª–∞–Ω –ü–∏—Ç–∞–Ω–∏—è</span>
                            </button>

                            <hr class="my-6 border-emerald-200">
                            
                            <h4 class="font-bold text-emerald-900 mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–º–∏–Ω–∫–∏</h4>
                            <ul class="text-sm text-emerald-800 space-y-1 list-disc list-inside">
                                <li>5-10 –º–∏–Ω –ª–µ–≥–∫–æ–µ –∫–∞—Ä–¥–∏–æ</li>
                                <li>–°—É—Å—Ç–∞–≤–Ω–∞—è –≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞</li>
                                <li>2 –ø–æ–¥—Ö–æ–¥–∞ —Ä–∞–∑–º–∏–Ω–∫–∏ (50% –∏ 70% –≤–µ—Å–∞)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Visualization Section -->
        <section id="forecast" class="py-12 max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <!-- Structure Viz -->
                <div>
                    <h3 class="text-xl font-bold text-slate-900 mb-4">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏</h3>
                    <p class="text-slate-600 text-sm mb-6">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª–∏ 4 –∏ 8 ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Å–ø–∞–¥ –¥–ª—è —Å—É–ø–µ—Ä–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.</p>
                    <div class="chart-container bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
    7                    <canvas id="structureChart"></canvas>
                    </div>
                </div>

                <!-- Simulation Viz -->
                <div>
                    <h3 class="text-xl font-bold text-slate-900 mb-4">–°–∏–º—É–ª—è—Ç–æ—Ä –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ (–ñ–∏–º –Ω–æ–≥–∞–º–∏)</h3>
                    <p class="text-slate-600 text-sm mb-4">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–±–æ—á–∏–π –≤–µ—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ü–µ–ª—å –∫ –∫–æ–Ω—Ü—É 8-–π –Ω–µ–¥–µ–ª–∏.</p>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <label class="text-sm font-semibold text-slate-700">–°—Ç–∞—Ä—Ç–æ–≤—ã–π –≤–µ—Å (–∫–≥):</label>
                        <input type="number" id="startWeightInput" value="100" class="w-24 p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 outline-none" onchange="updateProgressionChart()">
                    </div>

                    <div class="chart-container bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <canvas id="progressionChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-8 text-center text-sm">
        <p>–°–æ–∑–¥–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ 8-–Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã Full-Body.</p>
        <p class="mt-2 text-slate-500">–ü–æ–º–Ω–∏—Ç–µ: –¢–µ—Ö–Ω–∏–∫–∞ > –í–µ—Å.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- API CONFIGURATION ---
        const apiKey = "";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // --- UTILITY FUNCTIONS ---

        function showModal(title, content, sources = []) {
            const modal = document.getElementById('app-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = content;
            
            const sourcesContainer = document.getElementById('modal-sources');
            const sourcesList = document.getElementById('sources-list');
            sourcesList.innerHTML = '';

            if (sources.length > 0) {
                sources.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${s.uri}" target="_blank" class="text-blue-600 hover:text-blue-800">${s.title}</a>`;
                    sourcesList.appendChild(li);
                });
                sourcesContainer.classList.remove('hidden');
            } else {
                sourcesContainer.classList.add('hidden');
            }

            modal.style.display = 'flex';
            document.getElementById('modal-loading').classList.add('hidden');
        }

        function showLoading(title) {
            const modal = document.getElementById('app-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = `<div class="flex justify-center items-center py-8"><div class="loading-spinner"></div></div><p class="text-center mt-4">–ò–¥–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è...</p>`;
            document.getElementById('modal-sources').classList.add('hidden');
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('app-modal').style.display = 'none';
        }

        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- GEMINI API CALLS ---

        async function generateNutritionStrategy() {
            const currentWeekType = weekLogic[currentWeek].type; // Base, Progression, Peak, Deload
            const weekDescription = weekLogic[currentWeek].msg;

            showLoading(`‚ú® –ü–ª–∞–Ω –ü–∏—Ç–∞–Ω–∏—è: –ù–µ–¥–µ–ª—è ${currentWeek}`);
            
            const systemPrompt = "–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–π, –æ–¥–Ω–æ–ø–∞—Ä–∞–≥—Ä–∞—Ñ–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞–∫—Ä–æ—Å–∞–º (–±–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã) –∏ –∫–∞–ª–æ—Ä–∏—è–º, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Ç–∏–ø–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –Ω–µ–¥–µ–ª–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.";
            const userQuery = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–∞—è –Ω–µ–¥–µ–ª—è: ${currentWeekType} (${weekDescription}). –¢—Ä–µ–±—É–µ—Ç—Å—è: –ö—Ä–∞—Ç–∫–∏–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è –≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∏–ª—ã.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = response.candidates?.[0];
                let content = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    content = candidate.content.parts[0].text.replace(/\n/g, '<br>');
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }
                showModal(`‚ú® –ü–ª–∞–Ω –ü–∏—Ç–∞–Ω–∏—è: –ù–µ–¥–µ–ª—è ${currentWeek}`, content, sources);

            } catch (error) {
                showModal(`–û—à–∏–±–∫–∞ API`, `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini: ${error.message}`);
            }
        }

        async function generateTechniqueChecklist(exerciseName, instruction) {
            showLoading(`‚ú® –¢–µ—Ö–Ω–∏–∫–∞: ${exerciseName}`);
            
            const currentReps = weekLogic[currentWeek].mod({ base: "3x10" }); // Use a generic base to get RIR info
            const currentRIR = (currentWeek === 7) ? "RIR 1 (–ø–æ—á—Ç–∏ –æ—Ç–∫–∞–∑)" : (currentWeek === 3) ? "RIR 2" : "RIR 2-3"; // Approximate RIR based on week
            
            const systemPrompt = "–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø—É–Ω–∫—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –¥–≤–∞ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–∞–ª–∞ –≤ —Ñ–æ—Ä–º–µ (–æ—à–∏–±–∫–∏) –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –∞—Ç–ª–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å RIR 1-3. –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç –≤ –≤–∏–¥–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç.";
            const userQuery = `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ${exerciseName}. –¢–µ–∫—É—â–∏–π RIR/–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${currentRIR}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = response.candidates?.[0];
                let content = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    // Format the response for display (replace - or * with list items)
                    content = text.split('\n').map(line => {
                        if (line.trim().startsWith('-') || line.trim().startsWith('*')) {
                            return `<li class="text-sm ml-4 list-disc">${line.substring(1).trim()}</li>`;
                        }
                        return `<p class="mt-2 text-base font-semibold">${line}</p>`;
                    }).join('');
                    
                    content = `<p class="font-bold text-slate-800 mb-2">–ö–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã:</p><ul class="space-y-1">${content}</ul>`;
                }

                showModal(`‚ú® –¢–µ—Ö–Ω–∏–∫–∞: ${exerciseName}`, content);

            } catch (error) {
                showModal(`–û—à–∏–±–∫–∞ API`, `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Gemini: ${error.message}`);
            }
        }

        // --- DATA STORE ---
        
        const programData = {
            weeks: [1, 2, 3, 4, 5, 6, 7, 8],
            days: ['Mon', 'Wed', 'Fri'],
            // Structure definitions for Charts
            intensity: [70, 80, 90, 40, 75, 85, 95, 40], // Relative intensity %
            
            // Workout Definitions
            workouts: {
                Mon: {
                    title: "–ì—Ä—É–¥—å + –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ç—è–≥–∞ + –†—É–∫–∏",
                    exercises: [
                        { name: "–ñ–∏–º –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ", base: "4x8", id: "chest_press", group: "–ì—Ä—É–¥–Ω—ã–µ, –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å" },
                        { name: "–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", base: "4x10", id: "lat_pull", group: "–®–∏—Ä–æ—á–∞–π—à–∏–µ –º—ã—à—Ü—ã —Å–ø–∏–Ω—ã" },
                        { name: "–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏", base: "3x12", note: "–¢–µ–º–ø 1-0-1", id: "lat_raise", group: "–°—Ä–µ–¥–Ω—è—è –¥–µ–ª—å—Ç–∞" },
                        { name: "–¢—Ä–∏—Ü–µ–ø—Å –Ω–∞ –±–ª–æ–∫–µ", base: "3x10", id: "tricep", group: "–¢—Ä–∏—Ü–µ–ø—Å" },
                        { name: "–ë–∏—Ü–µ–ø—Å –≤ –º–∞—à–∏–Ω–µ", base: "3x10", id: "bicep", group: "–ë–∏—Ü–µ–ø—Å" }
                    ]
                },
                Wed: {
                    title: "–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å + –ó–∞–¥–Ω—è—è —Ü–µ–ø—å",
                    exercises: [
                        { name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π (–Ω–∞–∫–ª–æ–Ω 30¬∞)", base: "4x10", id: "incline_press", group: "–ì—Ä—É–¥–Ω—ã–µ, –≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å" },
                        { name: "–¢—è–≥–∞ –∫ –ø–æ—è—Å—É", base: "4x10", id: "row", group: "–°–ø–∏–Ω–∞, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ç—è–≥–∞" },
                        { name: "–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥ –ª—ë–∂–∞", base: "3x12", id: "leg_curl", group: "–ë–∏—Ü–µ–ø—Å –±–µ–¥—Ä–∞" },
                        { name: "–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ (–∑–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞)", base: "3x12", note: "–¢–µ–º–ø 1-0-1", id: "rear_delt", group: "–ó–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞" },
                        { name: "–ü—Ä–µ—Å—Å (—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è)", base: "3x12", id: "abs", group: "–ü—Ä–µ—Å—Å" }
                    ]
                },
                Fri: {
                    title: "–ù–æ–≥–∏ (–¢—è–∂—ë–ª—ã–µ) + –í–µ—Ä—Ö",
                    exercises: [
                        { name: "–ñ–∏–º –Ω–æ–≥–∞–º–∏ (–¢—è–∂—ë–ª—ã–π)", base: "4x8", note: "–ü—Ä–∏–±–∞–≤–∫–∞ +5-10–∫–≥", id: "leg_press", group: "–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å—ã, —è–≥–æ–¥–∏—Ü—ã" },
                        { name: "–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è / –ì—Ä–∞–≤–∏—Ç—Ä–æ–Ω", base: "4x10", id: "pullup", group: "–®–∏—Ä–æ—á–∞–π—à–∏–µ –º—ã—à—Ü—ã —Å–ø–∏–Ω—ã" },
                        { name: "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞", base: "3x8", id: "bench", group: "–ì—Ä—É–¥–Ω—ã–µ" },
                        { name: "–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", base: "3x12", id: "leg_ext", group: "–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å—ã" },
                        { name: "–ë–∏—Ü–µ–ø—Å (–æ–±—Ä. —Ö–≤–∞—Ç)", base: "3x10", id: "bicep_rev", group: "–ü—Ä–µ–¥–ø–ª–µ—á—å—è, –±–∏—Ü–µ–ø—Å" },
                        { name: "–¢—Ä–∏—Ü–µ–ø—Å (–∏–∑-–∑–∞ –≥–æ–ª–æ–≤—ã)", base: "3x10", id: "tricep_ov", group: "–¢—Ä–∏—Ü–µ–ø—Å" }
                    ]
                }
            }
        };

        // Specific modifications per week
        const weekLogic = {
            1: { type: "Base", msg: "–ë–∞–∑–æ–≤–∞—è –Ω–µ–¥–µ–ª—è. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–±–æ—á–∏–π –≤–µ—Å RPE 7.", mod: (ex) => ex.base },
            2: { type: "Progression", msg: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å! +2.5–∫–≥ –¥–ª—è –≤–µ—Ä—Ö–∞, +5-10–∫–≥ –¥–ª—è –Ω–æ–≥.", mod: (ex) => {
                if(ex.base.startsWith('4x8')) return '4x7';
                if(ex.base.startsWith('4x10')) return '4x9';
                if(ex.base.startsWith('3x12')) return '3x11';
                if(ex.base.startsWith('3x10')) return '3x9-10'; // Keep range
                if(ex.base.startsWith('3x8')) return '3x7';
                return ex.base;
            }},
            3: { type: "Peak", msg: "–ü–∏–∫ –º–µ–∑–æ—Ü–∏–∫–ª–∞. –ï—â–µ +2.5–∫–≥/+5–∫–≥. –ë—É–¥–µ—Ç —Ç—è–∂–µ–ª–æ.", mod: (ex) => {
                if(ex.base.startsWith('4x8')) return '4x6';
                if(ex.base.startsWith('4x10')) return '4x8';
                if(ex.base.startsWith('3x12')) return '3x10';
                if(ex.base.startsWith('3x10')) return '3x8-10';
                if(ex.base.startsWith('3x8')) return '3x6';
                return ex.base;
            }},
            4: { type: "Deload", msg: "–†–ê–ó–ì–†–£–ó–ö–ê. –°–Ω–∏–∑—å—Ç–µ –≤–µ—Å–∞ –Ω–∞ 50%. –¢–µ—Ö–Ω–∏–∫–∞ –∏–¥–µ–∞–ª—å–Ω–∞—è.", mod: (ex) => {
                // Halve sets roughly
                let parts = ex.base.split('x');
                let sets = Math.floor(parseInt(parts[0]) / 2) || 2;
                return `${sets}x${parts[1]}`;
            }},
            5: { type: "Base", msg: "–ù–æ–≤—ã–π —Ü–∏–∫–ª. –í–µ—Å —á—É—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –Ω–∞ –ù–µ–¥–µ–ª–µ 1.", mod: (ex) => ex.base },
            6: { type: "Progression", msg: "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –æ—Ç –ù–µ–¥–µ–ª–∏ 5.", mod: (ex) => weekLogic[2].mod(ex) }, // Same logic as wk 2
            7: { type: "Peak", msg: "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä—ã–≤–æ–∫. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –≤–µ—Å–∞ —Ü–∏–∫–ª–∞.", mod: (ex) => weekLogic[3].mod(ex) }, // Same logic as wk 3
            8: { type: "Deload", msg: "–§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–∞–∑–≥—Ä—É–∑–∫–∞.", mod: (ex) => weekLogic[4].mod(ex) }
        };

        // --- STATE ---
        let currentWeek = 1;
        let currentDay = 'Mon';
        
        // --- CHARTS INSTANCES ---
        let structureChartInst = null;
        let progressionChartInst = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderWeekSelector();
            renderWorkout();
            initStructureChart();
            initProgressionChart();
        });

        // --- RENDER FUNCTIONS ---

        function renderWeekSelector() {
            const container = document.getElementById('week-selector');
            container.innerHTML = '';
            programData.weeks.forEach(w => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold transition border-2 ${w === currentWeek ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-slate-500 border-slate-200 hover:border-emerald-300'}`;
                btn.innerText = w;
                btn.onclick = () => {
                    currentWeek = w;
                    renderWeekSelector(); // Re-render to update active class
                    renderWorkout();
                    updateWeekNotes();
                };
                container.appendChild(btn);
            });
            updateWeekNotes();
        }

        function selectDay(day) {
            currentDay = day;
            // Update Tab Styles
            ['Mon', 'Wed', 'Fri'].forEach(d => {
                const el = document.getElementById(`btn-${d}`);
                if (d === day) {
                    el.className = "px-6 py-2 rounded-md text-sm font-medium transition tab-active shadow-sm";
                } else {
                    el.className = "px-6 py-2 rounded-md text-sm font-medium transition tab-inactive";
                }
            });
            renderWorkout();
        }

        function updateWeekNotes() {
            const notesContainer = document.getElementById('week-notes');
            const logic = weekLogic[currentWeek];
            
            let html = `<p class="font-semibold text-emerald-700">${logic.type}</p>`;
            html += `<p>${logic.msg}</p>`;
            
            if (currentWeek === 4 || currentWeek === 8) {
                html += `<div class="mt-2 p-2 bg-emerald-100 rounded text-xs font-bold uppercase tracking-wide">üìâ –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å -50%</div>`;
            } else if (currentWeek > 1 && currentWeek !== 5) {
                html += `<div class="mt-2 p-2 bg-emerald-100 rounded text-xs font-bold uppercase tracking-wide">üìà –¶–µ–ª—å: –ü–æ–≤—ã—Å–∏—Ç—å –≤–µ—Å–∞</div>`;
            }

            notesContainer.innerHTML = html;
        }

        function renderWorkout() {
            const list = document.getElementById('workout-list');
            list.innerHTML = '';

            const dayData = programData.workouts[currentDay];
            const logic = weekLogic[currentWeek];

            // Day Title
            const header = document.createElement('div');
            header.innerHTML = `<h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">${dayData.title}</h3>`;
            list.appendChild(header);

            dayData.exercises.forEach(ex => {
                const card = document.createElement('div');
                card.className = "flex flex-col sm:flex-row items-start sm:items-center justify-between bg-white border border-slate-200 p-4 rounded-lg hover:border-emerald-400 transition group";
                
                // Calculate modified reps based on week logic
                let displayReps = logic.mod(ex);
                let instruction = "";

                // Deload specific styling
                let badgeClass = "bg-slate-100 text-slate-600";
                
                if (currentWeek === 4 || currentWeek === 8) {
                     instruction = "–í–µ—Å 50% –æ—Ç —Ä–∞–±–æ—á–µ–≥–æ";
                     badgeClass = "bg-emerald-100 text-emerald-700";
                } else {
                    // Progression instructions
                    if (currentWeek === 2 || currentWeek === 3 || currentWeek === 6 || currentWeek === 7) {
                        if (ex.id === 'leg_press') {
                            instruction = "–î–æ–±–∞–≤—å +5-10–∫–≥";
                        } else if (['chest_press', 'lat_pull', 'incline_press', 'row', 'bench'].includes(ex.id)) {
                             instruction = "–î–æ–±–∞–≤—å +2.5–∫–≥";
                        }
                    }
                    if (ex.note) instruction = instruction ? `${instruction} | ${ex.note}` : ex.note;
                }

                card.innerHTML = `
                    <div class="mb-3 sm:mb-0 sm:mr-4 flex-grow">
                        <h5 class="font-bold text-slate-900 group-hover:text-emerald-700 transition">${ex.name}</h5>
                        <p class="text-xs text-slate-500 mt-1">${instruction || "–°–æ–±–ª—é–¥–∞–π —Ç–µ—Ö–Ω–∏–∫—É"}</p>
                        <button onclick="generateTechniqueChecklist('${ex.name}', '${instruction}')" class="mt-2 text-xs font-medium text-emerald-600 hover:text-emerald-800 transition flex items-center space-x-1">
                            <span>‚ú® –¢–µ—Ö–Ω–∏–∫–∞ –∏ –û—à–∏–±–∫–∏</span>
                        </button>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <span class="inline-block px-3 py-1 rounded font-mono font-bold text-lg ${badgeClass}">${displayReps}</span>
                        <div class="text-xs text-slate-400 mt-1 text-center">–ü–æ–¥—Ö–æ–¥—ã √ó –ü–æ–≤—Ç</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- CHARTS FUNCTIONS ---

        function initStructureChart() {
            const ctx = document.getElementById('structureChart').getContext('2d');
            structureChartInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ù1 Base', '–ù2 Prog', '–ù3 Peak', '–ù4 Deload', '–ù5 Base', '–ù6 Prog', '–ù7 Peak', '–ù8 Deload'],
                    datasets: [{
                        label: '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (%)',
                        data: programData.intensity,
                        backgroundColor: (ctx) => {
                            const v = ctx.raw;
                            return v < 50 ? '#10b981' : '#334155'; // Emerald for deload, Slate for work
                        },
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function initProgressionChart() {
            const ctx = document.getElementById('progressionChart').getContext('2d');
            progressionChartInst = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['–°—Ç–∞—Ä—Ç', '–ù1', '–ù2', '–ù3', '–ù4 (Deload)', '–ù5', '–ù6', '–ù7', '–ù8 (Deload)'],
                    datasets: [{
                        label: '–†–∞–±–æ—á–∏–π –≤–µ—Å (–ö–≥)',
                        data: [], // Populated by update fn
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false } // Auto scale
                    }
                }
            });
            updateProgressionChart();
        }

        function updateProgressionChart() {
            const startWeight = parseFloat(document.getElementById('startWeightInput').value) || 100;
            const increment = 5; // Conservative estimate for legs

            // Logic: 
            // W1: Start
            // W2: +5
            // W3: +5
            // W4: Drop 50%
            // W5: Start + 2.5 (slight increase over W1)
            // W6: W5 + 5
            // W7: W6 + 5
            // W8: Drop 50%
            
            const w1 = startWeight;
            const w2 = w1 + increment;
            const w3 = w2 + increment;
            const w4 = w3 * 0.5;
            const w5 = w1 + 2.5; // New cycle starts slightly higher
            const w6 = w5 + increment;
            const w7 = w6 + increment;
            const w8 = w7 * 0.5;

            const data = [startWeight, w1, w2, w3, w4, w5, w6, w7, w8];
            
            progressionChartInst.data.datasets[0].data = data;
            progressionChartInst.update();
        }

        // --- UTILS ---
        function copyWorkoutToClipboard() {
            const dayData = programData.workouts[currentDay];
            const logic = weekLogic[currentWeek];
            
            let text = `üìÖ –ù–µ–¥–µ–ª—è ${currentWeek} - ${currentDay === 'Mon' ? '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫' : currentDay === 'Wed' ? '–°—Ä–µ–¥–∞' : '–ü—è—Ç–Ω–∏—Ü–∞'}\n`;
            text += `üî• ${dayData.title}\n`;
            text += `üìù –ó–∞–º–µ—Ç–∫–∏: ${logic.msg}\n\n`;
            
            dayData.exercises.forEach(ex => {
                let reps = logic.mod(ex);
                // Deload weight adjustment text
                let note = (currentWeek === 4 || currentWeek === 8) ? " (50% –≤–µ—Å–∞)" : "";
                text += `‚óªÔ∏è ${ex.name}: ${reps}${note}\n`;
            });
            
            text += `\nüéØ RPE 7-8 | –û—Ç–¥—ã—Ö 90-120—Å`;

            navigator.clipboard.writeText(text).then(() => {
                showModal('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', '–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.');
            }).catch(err => {
                showModal('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ${err.message}`);
            });
        }
    </script>
</body>
</html>